<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>hello phaser!</title>
    <script src="./phaser.min.js"></script>
    <script src="./tween.min.js"></script>
    <style>
        @font-face {
            font-family: 'LithosProBlack';
            src: url(./LithosPro-Black.otf);
            src: url(./LithosPro-Black.otf) format('opentype');
        }
        .fontPreload{
            font-family: 'LithosProBlack';
            opacity:0;
            position:fixed
        }
    </style>
</head>
<body>

<script type="text/javascript">

//window.onload = function() {

    //  Note that this html file is set to pull down Phaser 2.5.0 from the JS Delivr CDN.
    //  Although it will work fine with this tutorial, it's almost certainly not the most current version.
    //  Be sure to replace it with an updated version before you start experimenting with adding your own code.

// game.add|make.text|image|graphics|group|sprite
    var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
    function preload () {
        game.load.image('logo', './img/phaser.png');
        game.load.image('head1','./img/head/head_1.png');
        game.load.image('head2','./img/head/head_2.png');
        game.load.image('head0','./img/head/head_0.png');
        game.load.image('head_cover','./img/head/head_cover.png');

        game.load.spritesheet('rank_medal','./img/rank_medal.png',64,91,3);

        game.load.atlas('gift_atlas', './img/gift/gift_atlas.png', './img/gift/gift_atlas.json');
        game.load.spritesheet('gift_petal_sheet', './img/gift/petal_sheet.png',64,50,20);
    }
    function update() {
    }
    function create () {
//        var logo = game.add.sprite(game.world.centerX, game.world.centerY, 'logo');
//        logo.anchor.setTo(0.5, 0.5);

        addHead();

        var group = game.add.group();
        addText();
        addFlower(true);
        addBear(true);
        addParticle(true);

        addList();
    }
    function addParticle(loop) {
        var group = game.add.group();
        group.x = 100
        group.y = 300

        var self = this;
        var tweenArr = [];

        var flash = game.add.sprite(0, 0, 'gift_atlas','box_flash');
        flash.anchor.set(.5, .5);
        flash.scale.set(0, 0);
        flash.alpha = 0;
        group.add(flash);

        var star = game.add.emitter(0, 0, 50);
        group.add(star);
        star.alpha = 0;
        star.makeParticles('gift_atlas','box_star');
        star.setRotation(0, 0.8);
        star.setAlpha(0.3, 1);
        star.setXSpeed(50, 100);
        star.setYSpeed(50, 100);
        star.minParticleScale = 0.1;
        star.maxParticleScale = 0.5;
        star.minParticleSpeed.setTo(-400, -400);
        star.maxParticleSpeed.setTo(400, 400);
        star.flow(2000, 500, 5, -1);

        var twinkle = game.add.emitter(0, 0, 250);
        group.add(twinkle);
        twinkle.alpha = 0;
        twinkle.makeParticles('gift_atlas','box_twinkle');
        twinkle.setRotation(0, 0.8);
        twinkle.setAlpha(0.3, 1);
        twinkle.setXSpeed(50, 100);
        twinkle.setYSpeed(50, 100);
        twinkle.minParticleScale = 2;
        twinkle.maxParticleScale = 3;
        twinkle.minParticleSpeed.setTo(-400, -400);
        twinkle.maxParticleSpeed.setTo(400, 400);
        // emitter.twinklet(false, 5000, 20);
        twinkle.flow(2000, 500, 5, -1);

        var mask = game.add.graphics(0, 0);
        mask.anchor.set(0.5, 0.5);
        mask.beginFill(0xffffff);
        mask.drawCircle(0, 0, 242);
        group.add(mask);
        star.mask = mask;

        var mask2 = game.add.graphics(0, 0);
        mask2.anchor.set(0.5, 0.5);
        mask2.beginFill(0xffffff);
        mask2.drawCircle(0, 0, 242);
        group.add(mask2);
        twinkle.mask = mask2;

        var box = game.add.sprite(0, 0, 'gift_atlas','box');
        box.anchor.set(.5, .5);
        box.scale.set(.7, .7);
        group.add(box);

        tweenArr[0] = game.add.tween(flash).to({ alpha: 1 }, 500, TWEEN.Easing.Sinusoidal.In, false, 0, 0);
        tweenArr[1] = game.add.tween(flash.scale).to({ x: 1.2, y: 1.2 }, 500, TWEEN.Easing.Sinusoidal.In, false, 0);
        tweenArr[2] = game.add.tween(star).to({ alpha: 1 }, 100, TWEEN.Easing.Sinusoidal.Out, false, 300);
        tweenArr[3] = game.add.tween(twinkle).to({ alpha: 1 }, 100, TWEEN.Easing.Sinusoidal.Out, false, 300);
        tweenArr[4] = game.add.tween(box.scale).to({ x: 1, y: 1 }, 500, TWEEN.Easing.Sinusoidal.In, false, 0);
        tweenArr[5] = game.add.tween(star).to({ alpha: 0 }, 200, TWEEN.Easing.Sinusoidal.Out, false, 800);
        tweenArr[6] = game.add.tween(twinkle).to({ alpha: 0 }, 200, TWEEN.Easing.Sinusoidal.Out, false, 800);
        tweenArr[7] = game.add.tween(flash).to({ alpha: 0 }, 500, TWEEN.Easing.Sinusoidal.Out, false, 800);
        tweenArr[8] = game.add.tween(box).to({ alpha: 0.01 }, 500, TWEEN.Easing.Sinusoidal.Out, false, 800);
        tweenArr[9] = game.add.tween(box).to({ alpha: 0 }, 1, TWEEN.Easing.Sinusoidal.Out, false, 1800);

        tweens(loop);

        function tweens() {
            for (var i = 0; i < tweenArr.length; i++) {
                tweenArr[i].start();
            }

            tweenArr[tweenArr.length - 1].onComplete.addOnce(function() {
                if (loop) {
                    resetSprite();
                    tweens(true);
                } else {
                    group.children.forEach(function(item) {
                        item.destroy();
                    })
                }
            }, this);
        }

        function resetSprite() {
            flash.alpha = 0;
            flash.scale.set(1, 1);
            box.scale.set(.7, .7);
            star.alpha = 1;
            twinkle.alpha = 1;
            box.alpha = 1;
        }

        return group;
    }
    function addBear(loop) {
        var group = game.add.group();
        group.x = 300
        group.y = 100

        var bear = game.add.sprite(0, 0, 'gift_atlas', 'bear');
        bear.anchor.set(.5, .5);
        group.add(bear);

        var tweenArr = [];
        tweenArr[0] = game.add.tween(bear.scale).to({ x: 1.05, y: 0.95 }, 100, Phaser.Easing.Bounce.InOut, false, 0, 4, true);
        tweenArr[1] = game.add.tween(bear).to({ alpha: 0.01 }, 800, Phaser.Easing.Bounce.InOut, false, 800);
        tweenArr[2] = game.add.tween(bear).to({ alpha: 0 }, 1, Phaser.Easing.Bounce.InOut, false, 1800);

        setHeart(this, 20, -60, 20, -80, 0, 1.2);
        setHeart(this, -20, -10, -40, -20, 100, 1);
        setHeart(this, 40, -10, 60, 0, -15, 1);
        setHeart(this, -40, 50, -30, 70, 200, 1);
        setHeart(this, 20, 60, 30, 90, 160, .8);

        function setHeart(_this, oX, oY, tX, tY, oAngle, scale) {
            var heart = game.add.sprite(oX, oY, 'gift_atlas','heart');
            var tAngle = Math.random() * 360 - 180;
            heart.anchor.set(.5);
            heart.angle = oAngle;
            heart.scale.set(scale, scale);
            group.add(heart);
            game.add.tween(heart).to({ x: tX, y: tY }, 500, Phaser.Easing.Linear.None, true, 0);
            game.add.tween(heart).to({ alpha: 0 }, 500, Phaser.Easing.Linear.None, true, 400);
            game.add.tween(heart).to({ angle: tAngle }, 1000, Phaser.Easing.Linear.None, true, 0).onComplete.addOnce(function() {
                heart.destroy();
                // tween.remove();
            }, this)
        }

        tweens(loop);

        function tweens(loop) {
            tweenArr[0].start();
            tweenArr[1].start();
            tweenArr[2].start();

            setHeart(this, 20, -60, 20, -80, 0, 1.2);
            setHeart(this, -20, -10, -40, -20, 100, 1);
            setHeart(this, 40, -10, 60, 0, -15, 1);
            setHeart(this, -40, 50, -30, 70, 200, 1);
            setHeart(this, 20, 60, 30, 90, 160, .8);

            tweenArr[2].onComplete.addOnce(function() {
                if (loop) {
                    resetSprite();
                    tweens(true);
                } else {
                    group.children.forEach(function(item) {
                        item.destroy();
                    })
                }
            }, this);
        }

        function resetSprite() {
            bear.scale.set(1, 1);
            bear.alpha = 1;
        }
        return group;
    }
    function addFlower(loop) {
        var group = game.add.group();
        group.x = 100
        group.y = 100

        var flower = game.add.sprite(0, 0, 'gift_atlas', 'flower');
        flower.anchor.set(.5, .5);
        group.add(flower);

        var tweenArr = []
        var rumbleOffset = 0.2;
        var ease = Phaser.Easing.Linear.None;
        tweenArr[0] = game.add.tween(flower).to({ rotation: flower.rotation - rumbleOffset }, 100, ease, true, 500, 4, true);
        tweenArr[1] = game.add.tween(flower).to({ alpha: 0.01 }, 400, ease, true, 900);
        tweenArr[2] = game.add.tween(flower).to({ alpha: 0 }, 1, ease, true, 1400);

        for (var i = 0; i < 7; i++) {
            _addPetal(group, loop);
        }

        function _addPetal(group, loop) {
            var delay = Math.random() * 1000;
            var duration = Math.random() * 500 + 500;
            var angle = Math.random() * 2 * Math.PI;
            var radius = 70;
            var startFrame = Math.floor(Math.random() * 20);
            var tX = radius * Math.cos(angle);
            var tY = radius * Math.sin(angle);

            var petal = game.add.sprite(0, 0, 'gift_petal_sheet', startFrame);
            petal.anchor.set(.5, .5);
            petal.animations.add('move');
            petal.animations.play('move', 10, true);
            group.add(petal);

            var ease = Phaser.Easing.Linear.None;
            game.add.tween(petal).to({ x: tX, y: tY }, duration, ease, true, delay);
            game.add.tween(petal).to({ alpha: 0 }, 1000, ease, true, delay + 500).onComplete.addOnce(function() {
                loop ? (flower.alpha = 1) : petal.destroy();
            }, this)
        }
    }
    function addText() {
        var fontStyle = {
            font: '28px LithosProBlack',
            stroke:'#1a718e', strokeThickness: 5,
            fill:'#fff', align:'center'
        }
        game.add.text(30, 0, 'friends', fontStyle);
//        game.add.text(30, 10, '在这里显示我的名字', fontStyle);
    }
    function addHead() {
        var myHead = game.add.sprite(600, 60);

        var img_head = new CommonHead();
        img_head.width = 120;
        img_head.height = 120;
        myHead.addChild(img_head);

        var medal = game.make.sprite(0,0,'rank_medal');
        medal.animations.add('change');
        medal.animations.frame = 2;

        myHead.addChild(medal);
    }

    function CommonHead() {
        Phaser.Group.call(this, game, game.world, 'm_head');
        if(!game.headLoader)
            game.headLoader = new Phaser.Loader(game);

        this.headimg = game.make.sprite(5,5,'head2');
        this.add(this.headimg);

        this.headmask = game.make.graphics(0, 0);
        this.headmask.beginFill(0xffffff);
        this.headmask.drawRoundedRect(5,5,134,134,25);
        this.headmask.endFill();
//        this.headmask.visible = true;
        this.add(this.headmask);

        var headcover = game.make.sprite(0,0,'head_cover');
        this.add(headcover);


//        var index = 1;
//        var t = game.make.image(0, 0, 'head' + (index||'0'));
//        this.headimg.setTexture(t.texture);
        this.headimg.width = 134;
        this.headimg.height = 134;
        this.headimg.mask = this.headmask;
//        t.destroy();
    }
    CommonHead.prototype = Object.create(Phaser.Group.prototype);
    CommonHead.prototype.setFBHead = function(url,crownId){
    var self = this;
    game.headLoader.onLoadComplete.add(function(){
        var t = game.make.image(0,0,url);
        self.headimg.setTexture(t.texture);
        self.headimg.width = 134;
        self.headimg.height = 134;
        self.headmask.visible = true;
        self.headimg.mask = self.headmask;
    });
    game.headLoader.image(url, url);
    game.headLoader.start();
    game.loadFBHead = true;
};

    function addList() {
        var group = game.add.sprite();
        group.x = 100
        group.y = 200

        var viewHeight = 440;
        var itemHeight = 125;
        var initX = 238;
        var initY = 230;
        var ListMinY;
        var list = [
          {"character_id":100160006,"player_name":"主程","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/21314626_102783517131241_3976546844908802678_n.jpg?oh=8b49ce8e9c2a91d74cf2036d03e05dbe&oe=5AE1F124","grade":100,"medal":0,"online":false},
          {"character_id":100170006,"player_name":"程序","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/13690581_1629745264004410_3998140066923844756_n.jpg?oh=4d2456fabf0ddc020caea03c5d994ed6&oe=5AE1A2F9","grade":90,"medal":17000001,"online":false},
		  {"character_id":100270006,"player_name":"测试员","player_photo":"https://scontent.xx.fbcdn.net/v/t1.0-1/c94.0.320.320/p320x320/1379841_10150004552801901_469209496895221757_n.jpg?_nc_ad=z-m&_nc_cid=0&oh=91aec9452e4493201151d7441bf2682e&oe=5AE6A8A7","grade":35,"medal":17000001,"online":false},
          {"character_id":100430006,"player_name":"测试","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/p320x320/26113790_173159886770857_7572217612104779927_n.jpg?oh=87e7363ee7e3a1746cc5db79f00c844f&oe=5B138479","grade":35,"medal":17000201,"online":false},
          {"character_id":100500006,"player_name":"Lily","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/p320x320/22519212_105620420201399_2598983357123290703_n.jpg?oh=4510a9dd1c1cabbc63d80089da06c10f&oe=5ADEC2FB","grade":37,"medal":17000001,"online":false},
		  {"character_id":100700006,"player_name":"策划","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/p320x320/26904517_155337778579160_5454260768072639133_n.jpg?oh=a3ce7a423178cd74f881450132b3d8b9&oe=5B25AC07","grade":6,"medal":0,"online":false},
		  {"character_id":100790006,"player_name":"主管","player_photo":"https://scontent-nrt1-1.xx.fbcdn.net/v/t1.0-1/p320x320/22405470_148398849232076_5402598852506154971_n.jpg?oh=221ababbba57f01c42342b168a1b65c2&oe=5B20D4C0","grade":12,"medal":17000001,"online":false},
		  {"character_id":100810006,"player_name":"美术","player_photo":"https://scontent.xx.fbcdn.net/v/t1.0-1/p320x320/20139881_876541595830317_4865333803667682415_n.jpg?_nc_ad=z-m&_nc_cid=0&oh=4e433b99e9884b1f36027eab875f03cf&oe=5AF10FDC","grade":4,"medal":0,"online":false},
		  {"character_id":100830006,"player_name":"Kail","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/p320x320/26114143_122061045258429_8272112253373094789_n.jpg?oh=88dfca165332263300bd7b637f043e8e&oe=5AED45E9","grade":15,"medal":0,"online":false},
		  {"character_id":100840006,"player_name":"Tuxu","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/26165221_111451966323878_7189908332233748969_n.jpg?oh=e009daf6ad9ec89917164262929c5be2&oe=5B1FAABE","grade":1,"medal":0,"online":false},
		  {"character_id":100960006,"player_name":"SmallBean","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/c0.0.222.222/26047013_113716606092179_996853939114538692_n.jpg?oh=3dcb44f792cff5df0a24a19ba6bb26b9&oe=5B2656B8","grade":100,"medal":0,"online":false},
		  {"character_id":101000006,"player_name":"前端","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/p320x320/22528344_116668515761567_5887017643436266989_n.jpg?oh=7db04e1adf050620e974c9d780a8ffe8&oe=5B1B9992","grade":3,"medal":0,"online":false},
		  {"character_id":101040006,"player_name":"Joy Shop","player_photo":"https://scontent.xx.fbcdn.net/v/t1.0-1/p320x320/26000937_1996344657307887_7969968732145329165_n.jpg?_nc_ad=z-m&_nc_cid=0&oh=062acd0aaaf9f48b7ab0bd332e759fea&oe=5AF20439","grade":6,"medal":0,"online":false},
		  {"character_id":101160006,"player_name":"Andy","player_photo":"https://scontent.xx.fbcdn.net/v/t1.0-1/p320x320/22489781_118927548866382_9206156467210624388_n.jpg?_nc_ad=z-m&_nc_cid=0&oh=8c37e6cb48515e2044a658b331f68c9c&oe=5B1C775A","grade":6,"medal":0,"online":false},
		  {"character_id":101350006,"player_name":"负责人","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/c101.22.276.276/p320x320/247577_104885762938823_3177236_n.jpg?oh=a1f0a4cc4c6a1c3d1c3105a623ae45d8&oe=5B18E518","grade":8,"medal":17000001,"online":false},
		  {"character_id":102420006,"player_name":"后端开发","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/c0.0.320.320/p320x320/26195507_100193557453713_3725609807471806498_n.jpg?oh=9ee777291103e7422715ff4400ed3e16&oe=5B21ECFC","grade":4,"medal":0,"online":false},
		  {"character_id":103650006,"player_name":"美术编辑","player_photo":"https://scontent-hkg3-1.xx.fbcdn.net/v/t1.0-1/p320x320/22528082_134258247325696_7316642491119818851_n.jpg?oh=477c6df84bbb93f2a08b211a5b4d5fec&oe=5ADA2287","grade":1,"medal":0,"online":false}]
        for (var i = 0; i < list.length; i++) {
            var data = list[i];
            var node = addListItem(data);
            node.x = 0;
            node.y = itemHeight * i;
            ListMinY = -(itemHeight * (i + 1) - initY - viewHeight);
            if(ListMinY > initY) ListMinY = initY;

            group.addChild(node);
        }

        var _this = this;
        group.inputEnabled = true;
        group.input.enableDrag();
        group.input.allowHorizontalDrag = false;

        group.events.onInputDown.add(function(e) {
            var type = e.type;
            _this.gameDownY = game.input.y;
            _this[type + 'ListGroupY'] = e.y;
        });
        group.events.onInputUp.add(function(e) {
            var type = e.type;
            _this.gameUpY = game.input.y;
            if (_this.gameUpY == _this.gameDownY && _this.gameDownY > _this.initY && _this.gameDownY < (_this.initY + _this.viewHeight)) {
                // 点击
            } else if (_this.gameDownY > _this.initY && _this.gameDownY < (_this.initY + _this.viewHeight)) {
                // 拖拽
                if (e.y < _ListMinY) {
                    e.y = _ListMinY;
                }
                if (e.y > _this.initY) {
                    e.y = _this.initY;
                }
            }
        });
        group.events.onDragUpdate.add(function(e) {
            var type = e.type;
            if (_this.gameDownY < _this.initY || _this.gameDownY > (_this.initY + _this.viewHeight)) {
                e.y = _this[type + 'ListGroupY'];
            }
        });

        var maskPanel = game.make.graphics();
        maskPanel.beginFill(0xffffff);
        maskPanel.drawRect(group.x, group.y, 995, viewHeight);
        maskPanel.endFill();
        group.mask = maskPanel;
    }
    function addListItem(data){
        if(data.hartNum === undefined)
            data.hartNum = -1;

        var node = game.add.sprite(),
            onLineBg = game.add.image(0, 0, 'friend_bg_online'),
            offLineBg = game.add.image(0, 0, 'friend_bg_offline'),
            imgHead = new CommonHead(),
            onLineStyle = {
                font: "bold 23px Arial",
                strokeThickness: 4,
                stroke: '#0b4c5f',
                fill: "#fef489",
            },
            offLineStyle = {
                font: "bold 23px Arial",
                strokeThickness: 4,
                stroke: '#0b4c5f',
                fill: "#dadada",
            },
            onLineText = game.add.text(120, 12, 'Online', onLineStyle),
            offLineText = game.add.text(120, 12, 'Offline', offLineStyle),
            nameStyle = {
                font: "bold 24px Arial",
                fill: "#fff"
            },
            name = game.add.text(120, 45, data.player_name, nameStyle),
            lvStyle = {
                font: "bold 23px Arial",
                fill: "#106591"
            },
            lv = game.add.text(120, 71, 'LV.'+data.grade, lvStyle),
            hartNumStyle = {
                font: "bold 26px Arial",
                strokeThickness: 4,
                stroke: '#904f03'
            },
            hartNum = game.add.text(405, 50, data.hartNum, hartNumStyle),
            grd = hartNum.context.createLinearGradient(0, 0, 0, hartNum.canvas.height),
            hart = game.add.image(340, 49, 'friend_hart'),
            btn_del = game.add.button(891, 34, 'friend_del_request', function(btn){

            });

//        imgHead.setFBHead(data.player_photo); // todo
//        if(data.medal)
//            imgHead.addCrown(data.medal);
        imgHead.scale.setTo(0.625);
        imgHead.x = 15;
        imgHead.y = 17;

//        util.handleName(name, 240, 200);

        grd.addColorStop(0, '#fdf19f');
        grd.addColorStop(1, '#ffce22');
        hartNum.fill = grd;

        node.addChild(onLineBg);
        node.addChild(offLineBg);
        node.addChild(imgHead);
        node.addChild(onLineText);
        node.addChild(offLineText);
        node.addChild(name);
        node.addChild(lv);
        node.addChild(hartNum);
        node.addChild(hart);
        if(data.hartNum < 0){
            hartNum.visible = false;
            hart.visible = false;
        }
        node.addChild(btn_del);
        node.data = data;

        if(data.online){
            offLineBg.visible = false;
            offLineText.visible = false;
        }else{
            onLineBg.visible = false;
            onLineText.visible = false;
        }

        if(data.hartNum < 0){
            hartNum.visible = false;
            hart.visible = false;
        }

//        if(type == 'friend'){
//            btn_del.visible = false;
//        }
        return node;
    }

//};

</script>

</body>
</html>
